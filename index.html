<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meditation Timer</title>
    <script src="js/jquery-3.5.1.min.js"></script> 
    <script src="js/NoSleep.min.js"></script> 
    <script src="gui.js"></script>

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="gui.css">
  </head>
  <body>

    <div id="mySidebar" class="sidebar toggled">
      <a href="javascript:void(0)" class="closebtn" onclick="toggleNav()">×</a>
      <br>
      <div id="myGui"></div>

      <br><br>
      <button onClick="start_session()">Start Session</button>
      <div id="time_left"></div> 
    </div>

    <div id="main" class="toggled">
      <button class="openbtn" onclick="toggleNav()">☰ Open Sidebar</button>  
      <div id=circle class="circle_animation"></div>
    </div>

    <script>
      var noSleep = new NoSleep();
            var session_length = 0;
            var seconds_since_start = 0;
            var second_timer_func;
            $("#circle").hide();

            var gui = new Gui("myGui", [   
                    {'name': 'Minutes', 'type': 'string', 'default': 20},
                    {'name': 'Breath Time', 'type': 'string', 'default': 10},
                    {'name': 'Show Breath', 'type': 'boolean', 'default': true},
                    {'name': 'Start Chime', 'type': 'boolean', 'default': false},
                    {'name': 'End Chime', 'type': 'boolean', 'default': false},
                    {'name': 'Start Breath Tick', 'type': 'boolean', 'default': false},
                    {'name': 'End Breath Tick', 'type': 'boolean', 'default': false}
                  ]);

            function chime() {
                    var audio = new Audio('sounds/bell2.wav');
                    audio.play();
                  }

            function end_session() {
                    if ( gui.get("End Chime") ) {
                      chime();
                     }
                    console.log("Session ended");
                    window.clearTimeout(second_timer_func);
                    toggleNav();
                    seconds_since_start = 0;
                    $("#circle").hide();
                  }

            function second_updates() {
                    seconds_since_start+=1;
                    // $("#time_left").html((session_length * 60) - seconds_since_start);
                    // console.log(seconds_since_start);
                  }

            function start_session() {
                    toggleNav();

                    // Breath Time
                    var bt = gui.get("Breath Time");
                    $("#circle").css("animation-duration", bt + "s");
                    $("#circle").removeClass("circle_animation").addClass("circle_animation"); // reset the animation to make ticks line up

                    if ( gui.get("Show Breath") ) {
                            $("#circle").show();
                    }

                    
                    console.log("Session started");
                    session_length = parseInt(gui.get('Minutes'));
                    console.log("sessionlen:", session_length);

                    if ( gui.get("Start Chime") ) {
                      chime();
                     }

                    second_timer_func = setInterval( second_updates, 1000);
                    setTimeout( end_session, session_length * 60 * 1000);
                  }

            function toggleNav() {
                    $("#mySidebar").toggleClass("toggled");
                    $("#main").toggleClass("toggled");
                  }

            document.addEventListener('click', function enableNoSleep() {
                    document.removeEventListener('click', enableNoSleep, false);
                    noSleep.enable();
                  }, false);

    </script>
  </body>
</html>
